name: Email Ingestion

on:
  workflow_dispatch: # Allow manual triggering
  schedule:
    # Run every 2 hours from 6am-10pm Central (11:00-03:00 UTC, accounting for DST)
    - cron: "24 1,3,11,13,15,17,19,21,23 * * *"

jobs:
  ingest-emails:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "backend/.python-version"

      - name: Install dependencies
        run: |
          cd backend
          uv sync --locked

      - name: Process emails
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          PRIVACY_STRIP_PHRASES: ${{ secrets.PRIVACY_STRIP_PHRASES }}
          ENABLE_LLM: false
          ENABLE_NOTIFICATIONS: true
        run: |
          cd backend
          uv run python -m ingest.email.process_emails

      - name: Upload unmapped emails report (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unmapped-emails-${{ github.run_id }}
          path: backend/unmapped_emails_*.txt
          if-no-files-found: ignore
          retention-days: 30
