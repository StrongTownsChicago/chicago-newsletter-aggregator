name: Send Notification Digests

on:
  schedule:
    # Run daily at 13:35 UTC (8:35am CDT / 7:35am CST)
    # Sends digest containing yesterday's newsletters (Chicago timezone date)
    - cron: "35 13 * * *"
  workflow_dispatch:
    inputs:
      batch_id:
        description: "Batch ID to process (YYYY-MM-DD format, defaults to yesterday in Chicago timezone)"
        required: false
      dry_run:
        description: "Dry run mode (true/false)"
        required: false
        default: "false"

jobs:
  send-digests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: "backend/.python-version"

      - name: Install dependencies
        run: |
          cd backend
          uv sync --locked

      - name: Send daily digests
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NOTIFICATION_FROM_EMAIL: ${{ secrets.NOTIFICATION_FROM_EMAIL }}
          FRONTEND_BASE_URL: ${{ secrets.FRONTEND_BASE_URL }}
          UNSUBSCRIBE_SECRET_KEY: ${{ secrets.UNSUBSCRIBE_SECRET_KEY }}
        run: |
          cd backend
          ARGS="--daily-digest"
          if [ "${{ github.event.inputs.batch_id }}" != "" ]; then
            ARGS="$ARGS --batch-id ${{ github.event.inputs.batch_id }}"
          fi
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          uv run python -m notifications.process_notification_queue $ARGS
