---
export const prerender = false;

// Server-rendered: Fetches fresh data from Supabase on every request
import { supabase } from '../../lib/supabase';

const { id } = Astro.params;

const { data: newsletter, error } = await supabase
  .from('newsletters')
  .select('*')
  .eq('id', id)
  .single();

if (error || !newsletter) {
  return Astro.redirect('/404');
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{newsletter.subject} - Chicago Newsletters</title>
  </head>
  <body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <a href="/" class="text-blue-600 hover:underline mb-4 inline-block">‚Üê Back to newsletters</a>

      <article class="bg-white rounded-lg shadow p-8">
        <header class="mb-6">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            {newsletter.subject}
          </h1>
          <div class="text-gray-600 mb-4">
            {newsletter.source_name && <p>{newsletter.source_name}</p>}
            {newsletter.source_type && <p class="text-sm capitalize">{newsletter.source_type.replace('_', ' ')}</p>}
            {newsletter.source_metadata?.ward_number && <p>Ward {newsletter.source_metadata.ward_number}</p>}
            <p>{new Date(newsletter.received_date).toLocaleDateString()}</p>
          </div>

          {newsletter.topics && newsletter.topics.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {newsletter.topics.map((topic: string) => (
                <span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded">
                  {topic}
                </span>
              ))}
            </div>
          )}

          {newsletter.summary && (
            <div class="bg-gray-50 p-4 rounded border-l-4 border-blue-500">
              <p class="font-semibold text-sm text-gray-700 mb-1">Summary</p>
              <p class="text-gray-800">{newsletter.summary}</p>
            </div>
          )}
        </header>

        <div class="prose max-w-none">
          {newsletter.raw_html ? (
            <div set:html={newsletter.raw_html} />
          ) : (
            <div class="whitespace-pre-wrap">{newsletter.plain_text}</div>
          )}
        </div>
      </article>
    </div>
  </body>
</html>